<template>
  <article class="coordinate-selection">
    <section
      @click="inputActive = !inputActive"
      class="selected-input"
      :class="[{ inputActive: inputActive }, { isOutput: isOutput }, { outputNotSelected: outputNotSelected }]"
    >
      <span class="input-crs">
        <Icon v-if="isOutput && outputNotSelected"
          icon="HashtagIcon"
          :width="2"
          :height="2"
          :color="colors.white"
        />
        <Icon v-else
          icon="HashtagIcon"
          :width="2"
          :height="2"
          :color="colors.turquoise"
        />
        <div class="epsg-code">
          {{ chosenInput }}
        </div>
      </span>
      <Icon v-if="isOutput && outputNotSelected"
        icon="ExpandIcon"
        :width="2.5"
        :height="2.5"
        :color="colors.white"
        :stroke-width="0.75"
        class="expand-icon"
      />
      <Icon v-else
        icon="ExpandIcon"
        :width="2.5"
        :height="2.5"
        :color="colors.turquoise"
        :stroke-width="0.75"
        class="expand-icon"
      />
    </section>
    <section v-show="inputActive" class="crs-selection">
      <article class="selection-list" :class="{ isOutput: isOutput }">
        <ul v-for="CRS in filteredCRS" :key="CRS">
          <!-- TODO: move the click to a function -->
          <li
            @click="
              chosenInput = CRS.title_short;
              inputActive = false;
              if (isOutput)
                outputSelected(CRS);
              epsgChanged(CRS);
            "
          >
            {{ CRS.title_short }}
          </li>
        </ul>
      </article>
    </section>
  </article>
</template>

<script>
/**
 * EpsgSelection er drop-down menuen af EPSG-koder i både input- og outputkomponenterne
 */
import { onMounted, ref, inject } from 'vue'
import { useStore } from 'vuex'
import { useRoute } from 'vue-router'

export default {
  name: 'EpsgSelectionComponent',
  props: {
    // Er vi i input- eller outputkomponentet?
    isOutput: {
      type: Boolean,
      default () {
        return false
      }
    }
  },
  methods: {
    outputSelected (code) {
      // Der styles forskelligt alt efter om en EPSG-kode i outputmenuen er valgt, eller ej
      // I første instans er der ikke valgt nogen, men når først den er valgt, vil den blive ved med at være valgt.
      this.outputNotSelected = false
      this.$emit('output-selected', code)
    },
    epsgChanged (code) {
      // Hvis af en EPSG-koderne ændres, skal der foretages en passende ændring af input- og/eller outputkoordinaterne
      this.$emit('epsg-changed', code)
    }
  },
  setup (props) {
    const colors = inject('themeColors')
    const crs = ref([])
    const store = useStore()
    const route = useRoute()
    const chosenInput = ref('')
    const filteredCRS = ref([])
    const inputActive = ref(false)
    const outputNotSelected = ref(true)
    onMounted(() => {
      // Vi genererer listen af EPSG-koder
      store.dispatch('CRS/clear')
      store.dispatch('CRS/get', '').then(() => {
        crs.value = store.state.CRS.data
        makeCRSList()
      })
    })

    /**
     * generates the list of EPSG codes
     */
    const makeCRSList = async () => {
      const tempCRS = []
      // Der er forskellige lister for Danmark og Grønland
      if (route.name === 'Denmark' && crs.value.length !== 0) {
        for (let i = 0, iEnd = crs.value.DK.length; i < iEnd; ++i) {
          await store
            .dispatch('CRSInformation/get', crs.value.DK[i])
            .then(() => {
              tempCRS.push(store.state.CRSInformation.data)
            })
        }
        for (let i = 0, iEnd = crs.value.Global.length; i < iEnd; ++i) {
          await store
            .dispatch('CRSInformation/get', crs.value.Global[i])
            .then(() => {
              tempCRS.push(store.state.CRSInformation.data)
            })
        }
        filteredCRS.value = tempCRS
        chosenInput.value = props.isOutput
          ? 'Vælg koordinatsystem'
          : filteredCRS.value[0].title
      } else if (route.name === 'Greenland') {
        for (let i = 0, iEnd = crs.value.GL.length; i < iEnd; ++i) {
          await store
            .dispatch('CRSInformation/get', crs.value.GL[i])
            .then(() => {
              tempCRS.push(store.state.CRSInformation.data)
            })
        }
        for (let i = 0, iEnd = crs.value.Global.length; i < iEnd; ++i) {
          await store
            .dispatch('CRSInformation/get', crs.value.Global[i])
            .then(() => {
              tempCRS.push(store.state.CRSInformation.data)
            })
        }
        filteredCRS.value = tempCRS
        chosenInput.value = props.isOutput
          ? 'Vælg koordinatsystem'
          : filteredCRS.value[0].title
      }
    }
    return {
      colors,
      filteredCRS,
      chosenInput,
      inputActive,
      outputNotSelected
    }
  }
}
</script>

<style scoped>
.epsg-code {
  display: inline-flex;
  padding-left: 0.25rem;
}
.coordinate-selection {
  overflow: visible;
  width: 100%;
}
.selected-input {
  width: 100%;
  display: inline-flex;
  border: var(--darkSteel) solid 1px;
  border-radius: 25px;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}
.selected-input.isOutput {
  background: var(--white);
}
.selected-input.isOutput.outputNotSelected {
  background: var(--action);
  color: var(--white);
}
.selected-input.inputActive {
  border-radius: 25px 25px 0 0;
  border-bottom: none;
  width: 100%;
}
.input-crs {
  padding: 0 0 0 0.5rem;
  display: inline-flex;
  align-items: center;
}
.expand-icon {
  align-self: center;
  margin: 0 0 0 auto;
  transform: rotate(90deg);
}
.crs-selection {
  width: 100%;
  position: relative;
}
.selection-list {
  width: 100%;
  position: absolute;
  border: var(--darkSteel) solid 1px;
  border-radius: 0 0 25px 25px;
  z-index: 4;
  background: var(--white);
}
.selection-list.isOutput {
  background: var(--lightSteel);
}
li {
  list-style-type: none;
  padding: 0.5rem;
  margin: 0;
  border-bottom: var(--action) solid 1px;
}
li:hover {
  background-color: var(--action);
}
ul {
  list-style-type: none;
  padding: 0;
  margin: 0;
}
</style>
